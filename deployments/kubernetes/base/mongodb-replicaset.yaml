# ==============================================================================
# MongoDB Replica Set Configuration
# ==============================================================================
# StatefulSet with Primary + 2 Secondaries
# - Automatic election for failover
# - Read preference configurations
# ==============================================================================

---
# MongoDB ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-config
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
data:
  mongod.conf: |
    # MongoDB ReplicaSet Configuration
    storage:
      dbPath: /data/db
      journal:
        enabled: true
      wiredTiger:
        engineConfig:
          cacheSizeGB: 0.5
    
    net:
      port: 27017
      bindIp: 0.0.0.0
    
    replication:
      replSetName: crm-rs
      oplogSizeMB: 1024
    
    security:
      authorization: enabled
      keyFile: /etc/mongodb/keyfile
    
    setParameter:
      authenticationMechanisms: SCRAM-SHA-256
    
    operationProfiling:
      slowOpThresholdMs: 100
      mode: slowOp

  init-replicaset.sh: |
    #!/bin/bash
    set -e
    
    echo "Waiting for MongoDB to start..."
    until mongosh --quiet --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
      sleep 2
    done
    
    # Only initialize from the first pod
    if [ "$(hostname)" = "mongodb-0" ]; then
      echo "Initializing replica set from mongodb-0..."
      
      mongosh --quiet <<EOF
    rs.initiate({
      _id: "crm-rs",
      members: [
        { _id: 0, host: "mongodb-0.mongodb-headless:27017", priority: 2 },
        { _id: 1, host: "mongodb-1.mongodb-headless:27017", priority: 1 },
        { _id: 2, host: "mongodb-2.mongodb-headless:27017", priority: 1 }
      ]
    })
    EOF
      
      echo "Waiting for replica set to stabilize..."
      sleep 10
      
      # Create admin user
      mongosh --quiet <<EOF
    use admin
    db.createUser({
      user: "${MONGO_INITDB_ROOT_USERNAME}",
      pwd: "${MONGO_INITDB_ROOT_PASSWORD}",
      roles: [
        { role: "root", db: "admin" }
      ]
    })
    
    // Create application database and user
    use crm_customers
    db.createUser({
      user: "${MONGO_APP_USERNAME}",
      pwd: "${MONGO_APP_PASSWORD}",
      roles: [
        { role: "readWrite", db: "crm_customers" }
      ]
    })
    EOF
      
      echo "Replica set initialization complete"
    else
      echo "Skipping replica set init - not the primary node"
    fi

---
# MongoDB Keyfile Secret (for internal authentication)
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-keyfile
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
type: Opaque
stringData:
  # Generate with: openssl rand -base64 756
  keyfile: |
    CHANGE_ME_GENERATE_WITH_OPENSSL_RAND_BASE64_756
    THIS_SHOULD_BE_A_LONG_RANDOM_STRING_FOR_INTERNAL_AUTH

---
# MongoDB StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  serviceName: mongodb-headless
  replicas: 3
  podManagementPolicy: OrderedReady
  selector:
    matchLabels:
      app.kubernetes.io/name: mongodb
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mongodb
        app.kubernetes.io/component: database
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
      terminationGracePeriodSeconds: 60
      
      initContainers:
        - name: init-keyfile
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              cp /keyfile-secret/keyfile /etc/mongodb/keyfile
              chmod 400 /etc/mongodb/keyfile
              chown 999:999 /etc/mongodb/keyfile
          volumeMounts:
            - name: keyfile-secret
              mountPath: /keyfile-secret
            - name: keyfile
              mountPath: /etc/mongodb
          securityContext:
            runAsUser: 0
      
      containers:
        - name: mongodb
          image: mongo:7.0
          imagePullPolicy: IfNotPresent
          
          ports:
            - name: mongodb
              containerPort: 27017
              protocol: TCP
          
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: MONGODB_USER
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: MONGODB_PASSWORD
            - name: MONGO_APP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: MONGODB_APP_USER
            - name: MONGO_APP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: MONGODB_APP_PASSWORD
          
          command:
            - mongod
            - --config=/etc/mongo/mongod.conf
          
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - /scripts/init-replicaset.sh
          
          livenessProbe:
            exec:
              command:
                - mongosh
                - --quiet
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          
          readinessProbe:
            exec:
              command:
                - mongosh
                - --quiet
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
            - name: mongodb-config
              mountPath: /etc/mongo
            - name: keyfile
              mountPath: /etc/mongodb
              readOnly: true
            - name: init-scripts
              mountPath: /scripts
      
      volumes:
        - name: mongodb-config
          configMap:
            name: mongodb-config
            items:
              - key: mongod.conf
                path: mongod.conf
        - name: init-scripts
          configMap:
            name: mongodb-config
            defaultMode: 0755
            items:
              - key: init-replicaset.sh
                path: init-replicaset.sh
        - name: keyfile-secret
          secret:
            secretName: mongodb-keyfile
        - name: keyfile
          emptyDir: {}
  
  volumeClaimTemplates:
    - metadata:
        name: mongodb-data
        labels:
          app.kubernetes.io/name: mongodb-data
          app.kubernetes.io/component: database
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: crm-storage
        resources:
          requests:
            storage: 50Gi

---
# Headless Service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: mongodb-headless
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: mongodb
      port: 27017
      targetPort: mongodb
  selector:
    app.kubernetes.io/name: mongodb

---
# Primary Service (routes to current primary)
apiVersion: v1
kind: Service
metadata:
  name: mongodb-primary
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb-primary
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  ports:
    - name: mongodb
      port: 27017
      targetPort: mongodb
  selector:
    app.kubernetes.io/name: mongodb
    statefulset.kubernetes.io/pod-name: mongodb-0

---
# Read Service (all replicas for read distribution)
apiVersion: v1
kind: Service
metadata:
  name: mongodb-read
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb-read
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  ports:
    - name: mongodb
      port: 27017
      targetPort: mongodb
  selector:
    app.kubernetes.io/name: mongodb

---
# PodDisruptionBudget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mongodb-pdb
  namespace: crm
  labels:
    app.kubernetes.io/name: mongodb
    app.kubernetes.io/component: database
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: mongodb
