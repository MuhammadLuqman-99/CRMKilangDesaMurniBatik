;; ==============================================================================
;; PgBouncer Configuration for CRM Platform
;; ==============================================================================
;; Transaction-level pooling for high-performance database access
;; ==============================================================================

[databases]
;; Database connection definitions
;; Format: dbname = host=X port=Y dbname=Z

;; Read-Write connections (primary)
crm_iam = host=postgres port=5432 dbname=crm_iam
crm_sales = host=postgres port=5432 dbname=crm_sales
crm_notification = host=postgres port=5432 dbname=crm_notification

;; Read-Only connections (for replica, if configured)
;; crm_iam_ro = host=postgres-read port=5432 dbname=crm_iam
;; crm_sales_ro = host=postgres-read port=5432 dbname=crm_sales
;; crm_notification_ro = host=postgres-read port=5432 dbname=crm_notification

;; Wildcard for any other database
* = host=postgres port=5432

[pgbouncer]
;; ==============================================================================
;; Connection settings
;; ==============================================================================
listen_addr = 0.0.0.0
listen_port = 6432
unix_socket_dir = /var/run/pgbouncer

;; ==============================================================================
;; Authentication
;; ==============================================================================
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Use auth_query for dynamic user lookup from PostgreSQL
;; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;; ==============================================================================
;; Pool mode
;; ==============================================================================
;; session    - Client connected to server for whole session
;; transaction - Client uses server only during transaction (recommended)
;; statement  - Client uses server for single statement
pool_mode = transaction

;; ==============================================================================
;; Connection limits
;; ==============================================================================
;; Maximum number of client connections allowed
max_client_conn = 1000

;; Default pool size per database/user pair
default_pool_size = 20

;; Minimum pool size
min_pool_size = 5

;; Additional connections for reserve pool
reserve_pool_size = 5

;; Time to wait before reserve pool is used (seconds)
reserve_pool_timeout = 3

;; Maximum database connections per pool
;; max_db_connections = 100

;; Maximum user connections per pool
;; max_user_connections = 100

;; ==============================================================================
;; Timeouts (seconds)
;; ==============================================================================
;; Timeout for connecting to server
server_connect_timeout = 15

;; Retry delay after failed connection
server_login_retry = 15

;; Close server connections idle longer than this
server_idle_timeout = 600

;; Close server connections older than this
server_lifetime = 3600

;; Close client connections idle longer than this (0 = disable)
client_idle_timeout = 0

;; Client login timeout
client_login_timeout = 60

;; Cancel query if running longer than this (0 = disable)
query_timeout = 0

;; Wait time for query to get a server connection
query_wait_timeout = 120

;; ==============================================================================
;; Logging
;; ==============================================================================
;; Log connections
log_connections = 1

;; Log disconnections  
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Interval for logging stats
stats_period = 60

;; Verbosity level: debug, info, log, notice, warning, error
verbose = 0

;; ==============================================================================
;; Admin console
;; ==============================================================================
;; Users allowed SHOW commands
stats_users = pgbouncer_stats

;; Users allowed ALL commands
admin_users = pgbouncer_admin

;; ==============================================================================
;; Performance
;; ==============================================================================
;; Query to run on clean connection
server_reset_query = DISCARD ALL

;; Query for checking server health
server_check_query = SELECT 1

;; Delay between server health checks
server_check_delay = 30

;; Add host to application_name
application_name_add_host = 1

;; TCP keepalive settings
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 30
tcp_keepcnt = 3

;; ==============================================================================
;; TLS Settings (Production)
;; ==============================================================================
;; Client-side TLS
;; client_tls_sslmode = require
;; client_tls_key_file = /etc/pgbouncer/server.key
;; client_tls_cert_file = /etc/pgbouncer/server.crt
;; client_tls_ca_file = /etc/pgbouncer/ca.crt

;; Server-side TLS
;; server_tls_sslmode = require
;; server_tls_ca_file = /etc/pgbouncer/ca.crt
