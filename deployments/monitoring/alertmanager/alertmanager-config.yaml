apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@crm-platform.local'
      smtp_auth_username: '${SMTP_USERNAME}'
      smtp_auth_password: '${SMTP_PASSWORD}'

    route:
      group_by: ['alertname', 'service', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default-receiver'
      routes:
        # Critical alerts - immediate notification
        - match:
            severity: critical
          receiver: 'critical-receiver'
          group_wait: 10s
          repeat_interval: 1h
          continue: true

        # Warning alerts - standard notification
        - match:
            severity: warning
          receiver: 'warning-receiver'
          group_wait: 1m
          repeat_interval: 4h

        # Database alerts
        - match:
            category: database
          receiver: 'database-receiver'
          group_wait: 30s
          repeat_interval: 2h

        # Security alerts - immediate
        - match:
            category: security
          receiver: 'security-receiver'
          group_wait: 10s
          repeat_interval: 30m

    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: 'ops-team@crm-platform.local'
            send_resolved: true

      - name: 'critical-receiver'
        email_configs:
          - to: 'critical-alerts@crm-platform.local'
            send_resolved: true
        webhook_configs:
          - url: 'http://notification-service:8084/api/v1/webhooks/alerts'
            send_resolved: true

      - name: 'warning-receiver'
        email_configs:
          - to: 'ops-team@crm-platform.local'
            send_resolved: true

      - name: 'database-receiver'
        email_configs:
          - to: 'dba-team@crm-platform.local'
            send_resolved: true

      - name: 'security-receiver'
        email_configs:
          - to: 'security-team@crm-platform.local'
            send_resolved: true
        webhook_configs:
          - url: 'http://notification-service:8084/api/v1/webhooks/security-alerts'
            send_resolved: true

    inhibit_rules:
      # If critical, suppress warning for same alertname
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service']

      # If service is down, suppress all other alerts for that service
      - source_match:
          alertname: 'ServiceDown'
        target_match_re:
          alertname: '.+'
        equal: ['service']

    templates:
      - '/etc/alertmanager/templates/*.tmpl'
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
data:
  default.tmpl: |
    {{ define "email.default.subject" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }}
    {{ end }}

    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .alert { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .critical { background-color: #ff4444; color: white; }
        .warning { background-color: #ffaa00; color: black; }
        .info { background-color: #0099ff; color: white; }
        .resolved { background-color: #00aa00; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #4a4a4a; color: white; }
      </style>
    </head>
    <body>
      <h2>CRM Platform Alert Notification</h2>
      {{ range .Alerts }}
      <div class="alert {{ .Labels.severity }}{{ if eq .Status "resolved" }} resolved{{ end }}">
        <h3>{{ .Labels.alertname }} - {{ .Status | toUpper }}</h3>
        <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
        <p><strong>Service:</strong> {{ .Labels.service }}</p>
        <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>
        <table>
          <tr><th>Label</th><th>Value</th></tr>
          {{ range .Labels.SortedPairs }}
          <tr><td>{{ .Name }}</td><td>{{ .Value }}</td></tr>
          {{ end }}
        </table>
        <p><small>Started: {{ .StartsAt }}</small></p>
        {{ if eq .Status "resolved" }}
        <p><small>Ended: {{ .EndsAt }}</small></p>
        {{ end }}
      </div>
      {{ end }}
    </body>
    </html>
    {{ end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: alertmanager
  template:
    metadata:
      labels:
        app.kubernetes.io/name: alertmanager
        app.kubernetes.io/component: monitoring
    spec:
      securityContext:
        fsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
      containers:
        - name: alertmanager
          image: prom/alertmanager:v0.26.0
          imagePullPolicy: IfNotPresent
          args:
            - --config.file=/etc/alertmanager/alertmanager.yml
            - --storage.path=/alertmanager
            - --web.external-url=http://alertmanager.crm-platform.local
            - --cluster.listen-address=
          ports:
            - name: http
              containerPort: 9093
              protocol: TCP
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /etc/alertmanager
            - name: templates
              mountPath: /etc/alertmanager/templates
            - name: storage
              mountPath: /alertmanager
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: 9093
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /-/ready
              port: 9093
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: alertmanager-config
        - name: templates
          configMap:
            name: alertmanager-templates
        - name: storage
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: monitoring
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9093
      targetPort: 9093
      protocol: TCP
  selector:
    app.kubernetes.io/name: alertmanager
