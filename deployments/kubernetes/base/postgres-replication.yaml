# ==============================================================================
# PostgreSQL Replication Configuration
# ==============================================================================
# StatefulSet with Primary + Read Replicas
# - Streaming replication for high availability
# - WAL archiving for PITR support
# - Automatic failover ready
# ==============================================================================

---
# PostgreSQL ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
data:
  # Primary configuration
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    max_connections = 200
    
    # Memory Settings
    shared_buffers = 256MB
    effective_cache_size = 768MB
    maintenance_work_mem = 128MB
    work_mem = 16MB
    
    # WAL Settings for Replication
    wal_level = replica
    max_wal_senders = 4
    max_replication_slots = 4
    wal_keep_size = 1GB
    hot_standby = on
    hot_standby_feedback = on
    
    # WAL Archiving for PITR
    archive_mode = on
    archive_command = 'aws s3 cp %p s3://crm-backups/wal/%f --endpoint-url ${S3_ENDPOINT}'
    archive_timeout = 300
    
    # Synchronous Replication (optional - enable for zero data loss)
    # synchronous_commit = on
    # synchronous_standby_names = 'replica1'
    
    # Logging
    logging_collector = on
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d.log'
    log_statement = 'ddl'
    log_min_duration_statement = 1000
    
    # Performance
    random_page_cost = 1.1
    effective_io_concurrency = 200
    
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            md5
    host    all             all             0.0.0.0/0               md5
    host    replication     replicator      0.0.0.0/0               md5
    
  init-replication.sh: |
    #!/bin/bash
    set -e
    
    # Check if this is primary or replica
    if [ "$POSTGRES_ROLE" = "primary" ]; then
      echo "Configuring as PRIMARY"
      
      # Create replication user
      psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'replicator') THEN
            CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD '${REPLICATION_PASSWORD}';
          END IF;
        END
        \$\$;
        
        -- Create replication slots for each replica
        SELECT pg_create_physical_replication_slot('replica_slot_1') WHERE NOT EXISTS (
          SELECT 1 FROM pg_replication_slots WHERE slot_name = 'replica_slot_1'
        );
        SELECT pg_create_physical_replication_slot('replica_slot_2') WHERE NOT EXISTS (
          SELECT 1 FROM pg_replication_slots WHERE slot_name = 'replica_slot_2'
        );
      EOSQL
    else
      echo "Configuring as REPLICA"
      
      # Wait for primary to be ready
      until pg_isready -h postgres-0.postgres-headless -p 5432; do
        echo "Waiting for primary..."
        sleep 2
      done
      
      # Stop PostgreSQL
      pg_ctl stop -D "$PGDATA" -w
      
      # Clear data directory
      rm -rf "$PGDATA"/*
      
      # Base backup from primary
      PGPASSWORD=$REPLICATION_PASSWORD pg_basebackup \
        -h postgres-0.postgres-headless \
        -D "$PGDATA" \
        -U replicator \
        -vP \
        -W \
        -X stream \
        -c fast
      
      # Create standby signal
      touch "$PGDATA/standby.signal"
      
      # Configure replication connection
      cat >> "$PGDATA/postgresql.auto.conf" <<EOF
    primary_conninfo = 'host=postgres-0.postgres-headless port=5432 user=replicator password=${REPLICATION_PASSWORD}'
    primary_slot_name = 'replica_slot_${HOSTNAME##*-}'
    EOF
      
      # Start PostgreSQL
      pg_ctl start -D "$PGDATA" -w
    fi

---
# PostgreSQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  serviceName: postgres-headless
  replicas: 3  # 1 primary + 2 replicas
  podManagementPolicy: OrderedReady
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgres
        app.kubernetes.io/component: database
    spec:
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsNonRoot: true
      terminationGracePeriodSeconds: 60
      
      initContainers:
        - name: init-permissions
          image: busybox:1.36
          command: ['sh', '-c', 'chmod 700 /var/lib/postgresql/data']
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
          securityContext:
            runAsUser: 999
      
      containers:
        - name: postgres
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          
          ports:
            - name: postgres
              containerPort: 5432
              protocol: TCP
          
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: crm-secrets
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: "crm_main"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
            - name: REPLICATION_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-replication-secret
                  key: password
            - name: POSTGRES_ROLE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: S3_ENDPOINT
              value: "http://minio:9000"
          
          command:
            - /bin/sh
            - -c
            - |
              if [ "$POSTGRES_ROLE" = "postgres-0" ]; then
                export POSTGRES_ROLE=primary
              else
                export POSTGRES_ROLE=replica
              fi
              /scripts/init-replication.sh &
              docker-entrypoint.sh postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
          
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - $(POSTGRES_USER)
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - $(POSTGRES_USER)
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
            - name: postgres-config
              mountPath: /etc/postgresql
            - name: init-scripts
              mountPath: /scripts
      
      volumes:
        - name: postgres-config
          configMap:
            name: postgres-config
            items:
              - key: postgresql.conf
                path: postgresql.conf
              - key: pg_hba.conf
                path: pg_hba.conf
        - name: init-scripts
          configMap:
            name: postgres-config
            defaultMode: 0755
            items:
              - key: init-replication.sh
                path: init-replication.sh
  
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
        labels:
          app.kubernetes.io/name: postgres-data
          app.kubernetes.io/component: database
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: crm-storage
        resources:
          requests:
            storage: 50Gi

---
# Headless Service for StatefulSet DNS
apiVersion: v1
kind: Service
metadata:
  name: postgres-headless
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: postgres
      port: 5432
      targetPort: postgres
  selector:
    app.kubernetes.io/name: postgres

---
# Read-Write Service (Primary only)
apiVersion: v1
kind: Service
metadata:
  name: postgres-primary
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres-primary
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  ports:
    - name: postgres
      port: 5432
      targetPort: postgres
  selector:
    app.kubernetes.io/name: postgres
    statefulset.kubernetes.io/pod-name: postgres-0

---
# Read-Only Service (All replicas for read scaling)
apiVersion: v1
kind: Service
metadata:
  name: postgres-read
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres-read
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  ports:
    - name: postgres
      port: 5432
      targetPort: postgres
  selector:
    app.kubernetes.io/name: postgres

---
# Replication Secret
apiVersion: v1
kind: Secret
metadata:
  name: postgres-replication-secret
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres-replication
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: crm-platform
type: Opaque
stringData:
  password: "CHANGE_ME_REPLICATION_PASSWORD"

---
# PodDisruptionBudget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: postgres-pdb
  namespace: crm
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres
