# ==============================================================================
# PgBouncer Connection Pooler Deployment
# ==============================================================================
# Transaction-level pooling for PostgreSQL
# - Reduces connection overhead
# - Supports dynamic scaling
# - Health checks and metrics
# ==============================================================================

---
# PgBouncer ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: crm-platform
data:
  pgbouncer.ini: |
    ;; PgBouncer Configuration
    ;; Transaction-level pooling for CRM Platform
    
    [databases]
    ; Database connection definitions
    crm_iam = host=postgres-primary port=5432 dbname=crm_iam
    crm_sales = host=postgres-primary port=5432 dbname=crm_sales
    crm_notification = host=postgres-primary port=5432 dbname=crm_notification
    
    ; Read-only connections to replica pool
    crm_iam_ro = host=postgres-read port=5432 dbname=crm_iam
    crm_sales_ro = host=postgres-read port=5432 dbname=crm_sales
    crm_notification_ro = host=postgres-read port=5432 dbname=crm_notification
    
    ; Wildcard for any database
    * = host=postgres-primary port=5432
    
    [pgbouncer]
    ; Connection settings
    listen_addr = 0.0.0.0
    listen_port = 6432
    unix_socket_dir = /var/run/pgbouncer
    
    ; Authentication
    auth_type = md5
    auth_file = /etc/pgbouncer/userlist.txt
    auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1
    
    ; Pool mode (transaction is recommended for web apps)
    pool_mode = transaction
    
    ; Connection limits
    max_client_conn = 1000
    default_pool_size = 20
    min_pool_size = 5
    reserve_pool_size = 5
    reserve_pool_timeout = 3
    
    ; Timeouts
    server_connect_timeout = 15
    server_login_retry = 15
    server_idle_timeout = 600
    server_lifetime = 3600
    client_idle_timeout = 0
    client_login_timeout = 60
    query_timeout = 0
    query_wait_timeout = 120
    
    ; Logging
    log_connections = 1
    log_disconnections = 1
    log_pooler_errors = 1
    stats_period = 60
    
    ; Admin console
    admin_users = pgbouncer_admin
    stats_users = pgbouncer_stats
    
    ; Performance
    server_reset_query = DISCARD ALL
    server_check_query = SELECT 1
    server_check_delay = 30
    application_name_add_host = 1
    
    ; TLS (enable in production)
    ; client_tls_sslmode = require
    ; client_tls_key_file = /etc/pgbouncer/server.key
    ; client_tls_cert_file = /etc/pgbouncer/server.crt
    
  userlist.txt: |
    ; PgBouncer user list
    ; Format: "username" "password_hash"
    ; Generate with: echo -n "md5$(echo -n 'passwordusername' | md5sum | cut -d ' ' -f 1)"
    "crm_admin" "CHANGE_ME_PASSWORD_HASH"
    "pgbouncer_admin" "CHANGE_ME_ADMIN_HASH"
    "pgbouncer_stats" "CHANGE_ME_STATS_HASH"

---
# PgBouncer Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: crm-platform
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: pgbouncer
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pgbouncer
        app.kubernetes.io/component: connection-pooler
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9127"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      
      containers:
        - name: pgbouncer
          image: bitnami/pgbouncer:1.22.0
          imagePullPolicy: IfNotPresent
          
          ports:
            - name: pgbouncer
              containerPort: 6432
              protocol: TCP
          
          env:
            - name: PGBOUNCER_DATABASE
              value: "*"
            - name: POSTGRESQL_HOST
              value: "postgres-primary"
            - name: POSTGRESQL_PORT
              value: "5432"
            - name: PGBOUNCER_PORT
              value: "6432"
            - name: PGBOUNCER_BIND_ADDRESS
              value: "0.0.0.0"
          
          livenessProbe:
            tcpSocket:
              port: pgbouncer
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          
          readinessProbe:
            tcpSocket:
              port: pgbouncer
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          
          volumeMounts:
            - name: pgbouncer-config
              mountPath: /etc/pgbouncer
              readOnly: true
        
        # Prometheus exporter sidecar
        - name: exporter
          image: prometheuscommunity/pgbouncer-exporter:v0.7.0
          imagePullPolicy: IfNotPresent
          
          args:
            - "--pgBouncer.connectionString=postgres://pgbouncer_stats:$(PGBOUNCER_STATS_PASSWORD)@localhost:6432/pgbouncer?sslmode=disable"
          
          ports:
            - name: metrics
              containerPort: 9127
              protocol: TCP
          
          env:
            - name: PGBOUNCER_STATS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pgbouncer-secrets
                  key: stats-password
          
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
      
      volumes:
        - name: pgbouncer-config
          configMap:
            name: pgbouncer-config

---
# PgBouncer Service
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: crm-platform
spec:
  type: ClusterIP
  ports:
    - name: pgbouncer
      port: 6432
      targetPort: pgbouncer
    - name: metrics
      port: 9127
      targetPort: metrics
  selector:
    app.kubernetes.io/name: pgbouncer

---
# PgBouncer Secrets
apiVersion: v1
kind: Secret
metadata:
  name: pgbouncer-secrets
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
    app.kubernetes.io/part-of: crm-platform
type: Opaque
stringData:
  admin-password: "CHANGE_ME_ADMIN_PASSWORD"
  stats-password: "CHANGE_ME_STATS_PASSWORD"

---
# HorizontalPodAutoscaler
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: pgbouncer-hpa
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/component: connection-pooler
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: pgbouncer
  minReplicas: 2
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# PodDisruptionBudget
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: pgbouncer-pdb
  namespace: crm
  labels:
    app.kubernetes.io/name: pgbouncer
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: pgbouncer
