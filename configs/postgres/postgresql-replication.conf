# ==============================================================================
# PostgreSQL Replication Configuration
# ==============================================================================
# Enable WAL archiving for PITR and streaming replication
# ==============================================================================

# ==============================================================================
# Connection Settings
# ==============================================================================
listen_addresses = '*'
port = 5432
max_connections = 200

# ==============================================================================
# Memory Settings
# ==============================================================================
shared_buffers = 256MB
effective_cache_size = 768MB
maintenance_work_mem = 128MB
work_mem = 16MB

# ==============================================================================
# WAL Settings
# ==============================================================================
# Required for replication and PITR
wal_level = replica

# Number of concurrent streaming connections
max_wal_senders = 4

# Maximum number of replication slots
max_replication_slots = 4

# Minimum WAL to keep for streaming replication
wal_keep_size = 1GB

# Enable read queries on standby
hot_standby = on

# Send feedback to primary about query conflicts
hot_standby_feedback = on

# ==============================================================================
# WAL Archiving (for PITR)
# ==============================================================================
archive_mode = on

# Archive command - adjust for your storage backend
# For S3/MinIO:
# archive_command = 'aws s3 cp %p s3://crm-backups/wal/%f --endpoint-url http://minio:9000'

# For local storage:
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'

# Force archiving after this many seconds even if WAL not full
archive_timeout = 300

# ==============================================================================
# Synchronous Replication (Optional)
# ==============================================================================
# Enable for zero data loss (may impact write performance)
# synchronous_commit = on  
# synchronous_standby_names = 'replica1,replica2'

# ==============================================================================
# Checkpoints
# ==============================================================================
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 1GB

# ==============================================================================
# Logging
# ==============================================================================
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_messages = warning
log_min_error_statement = error
log_line_prefix = '%m [%p] %q%u@%d '
log_statement = 'ddl'
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on
log_temp_files = 0

# ==============================================================================
# Performance
# ==============================================================================
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

# ==============================================================================
# Autovacuum
# ==============================================================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
